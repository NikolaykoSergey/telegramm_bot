import logging
from typing import Optional
from local_ollama_client import OllamaClient
from local_config import ENABLE_TEXT_CLEANING

logger = logging.getLogger(__name__)


class TextCleaner:
    """–ß–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ LLM –ø–µ—Ä–µ–¥ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π"""

    def __init__(self):
        self.ollama = OllamaClient()
        self.enabled = ENABLE_TEXT_CLEANING
        logger.info(f"üßπ TextCleaner –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–≤–∫–ª—é—á—ë–Ω: {self.enabled})")

    def clean_text(self, text: str, file_name: str = "", page: int = 0) -> str:
        """
        –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ LLM

        Args:
            text: –°—ã—Ä–æ–π —Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            file_name: –ò–º—è —Ñ–∞–π–ª–∞ (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
            page: –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)

        Returns:
            –û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        """
        if not self.enabled:
            return text

        if not text or len(text.strip()) < 50:
            return text

        system_prompt = """–¢—ã ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –£–±—Ä–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã OCR (–ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã, –º—É—Å–æ—Ä)
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ (–ø–µ—Ä–µ-\n–Ω–æ—Å ‚Üí –ø–µ—Ä–µ–Ω–æ—Å)
3. –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –í–°–Æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (—Ü–∏—Ñ—Ä—ã, –∫–æ–¥—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏)
6. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è
7. –ù–ï –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –∏ –ù–ï –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞—Ç—å

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤."""

        prompt = f"""–û—á–∏—Å—Ç–∏ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –∏–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

–§–∞–π–ª: {file_name}
–°—Ç—Ä–∞–Ω–∏—Ü–∞: {page}

–¢–µ–∫—Å—Ç:
{text[:2000]}

–û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:"""

        try:
            cleaned = self.ollama.generate(prompt, system_prompt=system_prompt)

            # –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ LLM –≤–µ—Ä–Ω—É–ª–∞ –º—É—Å–æ—Ä –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç
            if len(cleaned) < len(text) * 0.3:
                logger.warning(f"‚ö†Ô∏è LLM –≤–µ—Ä–Ω—É–ª–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª")
                return text

            logger.debug(f"‚úÖ –¢–µ–∫—Å—Ç –æ—á–∏—â–µ–Ω: {len(text)} ‚Üí {len(cleaned)} —Å–∏–º–≤–æ–ª–æ–≤")
            return cleaned

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á–∏—Å—Ç–∫–µ —Ç–µ–∫—Å—Ç–∞: {repr(e)}")
            return text  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –ø—Ä–∏ –æ—à–∏–±–∫–µ

    def clean_table(self, table_text: str) -> str:
        """–û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ —Ç–∞–±–ª–∏—Ü—ã"""
        if not self.enabled:
            return table_text

        system_prompt = """–¢—ã ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü –∏–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –£–±—Ä–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã OCR
2. –í—ã—Ä–æ–≤–Ω—è—Ç—å —Å—Ç–æ–ª–±—Ü—ã
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ (—Ü–∏—Ñ—Ä—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è)
4. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ—á–∏—â–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É."""

        prompt = f"""–û—á–∏—Å—Ç–∏ —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É:

{table_text[:1500]}

–û—á–∏—â–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞:"""

        try:
            cleaned = self.ollama.generate(prompt, system_prompt=system_prompt)
            return cleaned if len(cleaned) > 20 else table_text

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á–∏—Å—Ç–∫–µ —Ç–∞–±–ª–∏—Ü—ã: {repr(e)}")
            return table_text
#